"use strict";(()=>{var t={};t.id=520,t.ids=[520],t.modules={399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1830:(t,e,a)=>{a.r(e),a.d(e,{originalPathname:()=>m,patchFetch:()=>y,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>c});var i={};a.r(i),a.d(i,{GET:()=>g});var n=a(9303),r=a(8716),s=a(670),o=a(7070),l=a(7478);async function g(t){try{let{searchParams:e}=new URL(t.url),a=Object.fromEntries(e.entries()),i=new l.y,n=await i.getAnalytics(a);return o.NextResponse.json({status:"success",data:n})}catch(t){return console.error("Error fetching analytics:",t),o.NextResponse.json({status:"error",error:"Failed to fetch analytics",message:t instanceof Error?t.message:"Unknown error"},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/reviews/analytics/route",pathname:"/api/reviews/analytics",filename:"route",bundlePath:"app/api/reviews/analytics/route"},resolvedPagePath:"/home/achref/Downloads/achref/app/api/reviews/analytics/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:d,staticGenerationAsyncStorage:c,serverHooks:p}=u,m="/api/reviews/analytics/route";function y(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:c})}},2663:(t,e,a)=>{a.d(e,{_:()=>n});let i=require("@prisma/client"),n=globalThis.prisma??new i.PrismaClient},5074:(t,e,a)=>{a.d(e,{Kb:()=>n,PQ:()=>s,y$:()=>r});var i=a(1067);let n=i.Ry({listingId:i.Z_().optional(),type:i.Z_().optional(),status:i.Z_().optional(),channel:i.Z_().optional(),minRating:i.oQ.number().min(0).max(10).optional(),maxRating:i.oQ.number().min(0).max(10).optional(),from:i.Z_().optional(),to:i.Z_().optional(),approved:i.oQ.boolean().optional(),q:i.Z_().optional(),page:i.oQ.number().min(1).default(1),pageSize:i.oQ.number().min(1).max(100).default(20),sort:i.Z_().optional()}),r=i.Ry({reviewId:i.Z_().cuid(),approved:i.O7()}),s=i.Ry({listingId:i.Z_().optional(),from:i.Z_().optional(),to:i.Z_().optional(),bucket:i.Km(["day","week","month"]).default("month")});i.Ry({id:i.Z_(),type:i.Z_(),status:i.Z_(),rating:i.Rx().optional(),publicReview:i.Z_().optional(),reviewCategory:i.IX(i.Ry({category:i.Z_(),rating:i.Rx()})).optional(),submittedAt:i.Z_(),guestName:i.Z_().optional(),listingName:i.Z_(),channel:i.Z_().optional()}),i.Ry({id:i.Z_(),source:i.Km(["hostaway","google"]),externalId:i.Z_().optional(),listing:i.Ry({id:i.Z_(),name:i.Z_()}),type:i.Km(["host-to-guest","guest-to-host"]),status:i.Km(["published","draft","hidden"]),ratingOverall:i.Rx().nullable().optional(),categories:i.IM(i.Rx()).optional(),text:i.Z_().optional(),authorName:i.Z_().optional(),channel:i.Z_().optional(),submittedAt:i.Z_(),approved:i.O7()})},7478:(t,e,a)=>{a.d(e,{y:()=>g});var i=a(2663),n=a(5074),r=a(4817),s=a(4347),o=a(2968),l=a(1834);class g{async getAnalytics(t){let e=n.PQ.parse(t),a={};e.listingId&&(a.listingId=e.listingId),(e.from||e.to)&&(a.submittedAt={},e.from&&(a.submittedAt.gte=new Date(e.from)),e.to&&(a.submittedAt.lte=new Date(e.to)));let i=await this.getTopListings(a);return{topListings:i,categoryAverages:await this.getCategoryAverages(a),trend:await this.getTrendData(a,e.bucket),issues:await this.getIssues(a)}}async getTopListings(t){let e=await i._.review.groupBy({by:["listingId"],where:t,_count:{id:!0},_avg:{ratingOverall:!0}}),a=e.map(t=>t.listingId),n=await i._.listing.findMany({where:{id:{in:a}},select:{id:!0,name:!0}});return e.map(t=>{let e=n.find(e=>e.id===t.listingId);return{listingId:t.listingId,name:e?.name||"Unknown",avgRating:t._avg.ratingOverall||0,count:t._count.id}}).sort((t,e)=>e.avgRating-t.avgRating).slice(0,5)}async getCategoryAverages(t){let e=await i._.review.findMany({where:t,select:{categories:!0}}),a={};e.forEach(t=>{t.categories&&Object.entries(t.categories).forEach(([t,e])=>{a[t]||(a[t]={sum:0,count:0}),a[t].sum+=e,a[t].count+=1})});let n={};return Object.entries(a).forEach(([t,{sum:e,count:a}])=>{n[t]=Math.round(e/a*10)/10}),n}async getTrendData(t,e){let a;let n=new Date;switch(e){case"day":a=(0,r.k)(n,30);break;case"week":a=(0,s.t)(n,12);break;case"month":a=(0,o.W)(n,12)}let g=await i._.review.groupBy({by:["submittedAt"],where:{...t,submittedAt:{gte:a}},_count:{id:!0},_avg:{ratingOverall:!0}}),u={};return g.forEach(t=>{let a;switch(e){case"day":a=(0,l.WU)(t.submittedAt,"yyyy-MM-dd");break;case"week":a=(0,l.WU)(t.submittedAt,"yyyy-'W'ww");break;case"month":a=(0,l.WU)(t.submittedAt,"yyyy-MM")}u[a]||(u[a]={sum:0,count:0,ratings:[]}),u[a].sum+=t._count.id,u[a].count+=1,t._avg.ratingOverall&&u[a].ratings.push(t._avg.ratingOverall)}),Object.entries(u).map(([t,e])=>({bucket:t,avgRating:e.ratings.length>0?Math.round(e.ratings.reduce((t,e)=>t+e,0)/e.ratings.length*10)/10:0,count:e.sum})).sort((t,e)=>t.bucket.localeCompare(e.bucket))}async getIssues(t){let e=await this.getCategoryAverages(t),a=[];return Object.entries(e).forEach(([t,e])=>{e<7&&a.push({category:t,avg:e,delta:-1.1})}),a}async getListingsWithStats(){let t=await i._.review.groupBy({by:["listingId"],_count:{id:!0},_avg:{ratingOverall:!0}}),e=t.map(t=>t.listingId),a=await i._.listing.findMany({where:{id:{in:e}},select:{id:!0,name:!0}});return t.map(t=>{let e=a.find(e=>e.id===t.listingId);return{id:t.listingId,name:e?.name||"Unknown",avgRating:Math.round(10*(t._avg.ratingOverall||0))/10,reviewCount:t._count.id}}).sort((t,e)=>e.avgRating-t.avgRating)}}}};var e=require("../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),i=e.X(0,[276,934,46],()=>a(1830));module.exports=i})();