"use strict";(()=>{var e={};e.id=365,e.ids=[365],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6663:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>c,patchFetch:()=>v,requestAsyncStorage:()=>u,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var a={};i.r(a),i.d(a,{GET:()=>d});var n=i(9303),r=i(8716),o=i(670),s=i(7070),l=i(6543);async function d(e){try{let{searchParams:t}=new URL(e.url),i=Object.fromEntries(t.entries()),a=new l.Y,n=await a.getReviews(i);return s.NextResponse.json({status:"success",data:n})}catch(e){return console.error("Error querying reviews:",e),s.NextResponse.json({status:"error",error:"Failed to query reviews",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/reviews/query/route",pathname:"/api/reviews/query",filename:"route",bundlePath:"app/api/reviews/query/route"},resolvedPagePath:"/home/achref/Downloads/achref/app/api/reviews/query/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:g}=p,c="/api/reviews/query/route";function v(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},2663:(e,t,i)=>{i.d(t,{_:()=>n});let a=require("@prisma/client"),n=globalThis.prisma??new a.PrismaClient},5074:(e,t,i)=>{i.d(t,{Kb:()=>n,PQ:()=>o,y$:()=>r});var a=i(1067);let n=a.Ry({listingId:a.Z_().optional(),type:a.Z_().optional(),status:a.Z_().optional(),channel:a.Z_().optional(),minRating:a.oQ.number().min(0).max(10).optional(),maxRating:a.oQ.number().min(0).max(10).optional(),from:a.Z_().optional(),to:a.Z_().optional(),approved:a.oQ.boolean().optional(),q:a.Z_().optional(),page:a.oQ.number().min(1).default(1),pageSize:a.oQ.number().min(1).max(100).default(20),sort:a.Z_().optional()}),r=a.Ry({reviewId:a.Z_().cuid(),approved:a.O7()}),o=a.Ry({listingId:a.Z_().optional(),from:a.Z_().optional(),to:a.Z_().optional(),bucket:a.Km(["day","week","month"]).default("month")});a.Ry({id:a.Z_(),type:a.Z_(),status:a.Z_(),rating:a.Rx().optional(),publicReview:a.Z_().optional(),reviewCategory:a.IX(a.Ry({category:a.Z_(),rating:a.Rx()})).optional(),submittedAt:a.Z_(),guestName:a.Z_().optional(),listingName:a.Z_(),channel:a.Z_().optional()}),a.Ry({id:a.Z_(),source:a.Km(["hostaway","google"]),externalId:a.Z_().optional(),listing:a.Ry({id:a.Z_(),name:a.Z_()}),type:a.Km(["host-to-guest","guest-to-host"]),status:a.Km(["published","draft","hidden"]),ratingOverall:a.Rx().nullable().optional(),categories:a.IM(a.Rx()).optional(),text:a.Z_().optional(),authorName:a.Z_().optional(),channel:a.Z_().optional(),submittedAt:a.Z_(),approved:a.O7()})},6543:(e,t,i)=>{i.d(t,{Y:()=>r});var a=i(2663),n=i(5074);class r{async getReviews(e){let t=n.Kb.parse(e),i={};t.listingId&&(i.listingId=t.listingId),t.type&&(i.type=t.type),t.status&&(i.status=t.status),t.channel&&(i.channel=t.channel),void 0!==t.approved&&(i.approved=t.approved),(t.minRating||t.maxRating)&&(i.ratingOverall={},t.minRating&&(i.ratingOverall.gte=t.minRating),t.maxRating&&(i.ratingOverall.lte=t.maxRating)),(t.from||t.to)&&(i.submittedAt={},t.from&&(i.submittedAt.gte=new Date(t.from)),t.to&&(i.submittedAt.lte=new Date(t.to))),t.q&&(i.OR=[{text:{contains:t.q,mode:"insensitive"}},{authorName:{contains:t.q,mode:"insensitive"}}]);let r={submittedAt:"desc"};if(t.sort){let[e,i]=t.sort.split(":");r={[e]:i||"desc"}}let o=t.page||1,s=t.pageSize||20,[l,d]=await Promise.all([a._.review.findMany({where:i,include:{listing:!0},orderBy:r,skip:(o-1)*s,take:s}),a._.review.count({where:i})]);return{items:l.map(e=>({id:e.id,source:e.source,externalId:e.externalId||void 0,listing:{id:e.listing.id,name:e.listing.name},type:e.type,status:e.status,ratingOverall:e.ratingOverall,categories:e.categories,text:e.text||void 0,authorName:e.authorName||void 0,channel:e.channel||void 0,submittedAt:e.submittedAt.toISOString(),approved:e.approved})),page:o,pageSize:s,total:d}}async approveReview(e,t,i){if(!await a._.review.findUnique({where:{id:e}}))throw Error("Review not found");await a._.$transaction([a._.review.update({where:{id:e},data:{approved:t}}),a._.reviewSelectionLog.create({data:{reviewId:e,action:t?"approved":"unapproved",actor:i}})])}async getPublicReviews(e){let t=await a._.listing.findUnique({where:{id:e}});if(!t)throw Error("Listing not found");let i=(await a._.review.findMany({where:{listingId:e,approved:!0},include:{listing:!0},orderBy:{submittedAt:"desc"}})).map(e=>({id:e.id,source:e.source,externalId:e.externalId||void 0,listing:{id:e.listing.id,name:e.listing.name},type:e.type,status:e.status,ratingOverall:e.ratingOverall,categories:e.categories,text:e.text||void 0,authorName:e.authorName||void 0,channel:e.channel||void 0,submittedAt:e.submittedAt.toISOString(),approved:e.approved}));return{listing:{id:t.id,name:t.name},items:i}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[276,934],()=>i(6663));module.exports=a})();